#!/usr/bin/perl

use JSON;
use Data::Dumper;
use HTTP::Request;
use LWP::UserAgent;

my $id = 0;

sub dbPut {
    my ($object, $index, $payobj) = @_;

    my $payload = &encode_json($payobj);

    my $req = HTTP::Request->new(PUT =>
        "http://172.16.100.194:9200/elasticsearch_kosai03/$object/$index");
    $req->content_type('application/json');
    $req->content($payload);

    if (0) {
        print "PUT http://172.16.100.194:9200/elasticsearch_kosai03/$object/$index\n";
        print &Dumper($payobj);
        return;
    }
    else {
        my $ua = LWP::UserAgent->new;
        $ua->agent("CrappyUserAgent");

        my $res = $ua->request($req);
        if ($res->is_success) {
            print "Deployed\n";
            print $res->content, "\n";
        }
        else {
            print $res->status_line, "\n";
        }
    }
}

sub putItems {
    my ($blob) = @_;

    my $item = {
        archive => $blob->{date},
        date => $blob->{date},
        text => []
    };
    my $iter = 0;
    for my $line (@{$blob->{text}}) {
        if ($line =~ m/^(\d+)\.$/) {
            if ($item->{item}) {
                &dbPut("items", $item->{item}, $item);
            }
            $iter++;
            $item->{text} = [];
            $item->{item} = $blob->{date} . "-$1";
        }
        push @{$item->{text}}, $line;
    }
    &dbPut("items", $item->{item}, $item);
}

for my $file (`ls data/*.txt`) {
    print $file;
    chomp $file;
    my @text;
    open (FH, "<$file");
    my $block = "";
    while(<FH>) {
        $_ =~ s/^\s+//;
        $_ =~ s/\s+$//;

        if ($_ =~ m/^\s*$/) {
            $block =~ s/\s+$//;
            push @text, $block if $block =~ m/\S/;
            $block = "";
        }
        else {
            $block .= $_ . " ";
        }
    }
    close(FH);

    my $pdfname = $file;
    $pdfname =~ s/data\///;
    $pdfname =~ s/txt$/pdf/;

    my $date = $pdfname;
    if ($date =~ m/a(\d+).(\d+).(\d+).*$/) {
        $date = "20$1$2$3";    
    }

    my $blobofstuff = {
        file => $pdfname,
        date => $date,
        text => \@text
    };
    #&dbPut("agendas",$date,$blobofstuff);
    &putItems($blobofstuff);
}
