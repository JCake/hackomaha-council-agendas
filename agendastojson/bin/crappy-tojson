#!/usr/bin/perl

use JSON;
use Data::Dumper;
use HTTP::Request;
use LWP::UserAgent;

use strict;
use warnings;

my $id = 0;

sub dbPut {
    my ($object, $index, $payobj) = @_;

    my $payload = &encode_json($payobj);
    my $req = HTTP::Request->new(PUT =>
        "http://simomaha.com:9200/citycouncil/$object/$index");
    $req->content_type('application/json');
    $req->content($payload);

    if (0) {
        print "PUT http://simomaha.com:9200/citycouncil/$object/$index\n";
        print &Dumper($payobj);
        return;
    }
    else {
        my $ua = LWP::UserAgent->new;
        $ua->agent("CrappyUserAgent");

        my $res = $ua->request($req);
        if ($res->is_success) {
            print "Deployed\n";
            print $res->content, "\n";
        }
        else {
            print $res->status_line, "\n";
        }
    }
}

sub putItems {
    my ($text) = @_;
    my @itemList;
    my $item = {
        text => [],
        index => 0
    };
    for my $line (@{$text}) {
        if ($line =~ m/^(\d+)\.$/) {
            if ($item->{index}) {
                push @itemList , $item;
            }
            $item = {
                text => [],
                index => $1
            };
        }
        else {
            push @{$item->{text}}, $line;
        }
    }
    push  @itemList, $item;
    return \@itemList;
}

for my $file (`ls data/*.txt`) {
    print $file;
    chomp $file;
    my @text;
    open (FH, "<$file");
    my $block = "";
    while(<FH>) {
        $_ =~ s/^\s+//;
        $_ =~ s/\s+$//;

        if ($_ =~ m/^\s*$/) {
            $block =~ s/\s+$//;
            push @text, $block if $block =~ m/\S/;
            $block = "";
        }
        else {
            $block .= $_ . " ";
        }
    }
    close(FH);

    my $pdfname = $file;
    $pdfname =~ s/data\///;
    $pdfname =~ s/txt$/pdf/;

    my $date = $pdfname;
    if ($date =~ m/a(\d+).(\d+).(\d+).*$/) {
        $date = "20$1-$2-$3";    
    }

    my $blobofstuff = {
        file => $pdfname,
        date => $date,
        text => \@text,
        items => &putItems(\@text)
    };
    &dbPut("agendas",$date,$blobofstuff);
}
